name: Find Good Commit

on:
  workflow_dispatch:
    inputs:
      commits_to_check:
        description: 'Number of commits to check (0 = all commits)'
        required: false
        default: '0'
        type: string
      error_message:
        description: 'Error message to search for'
        required: false
        default: 'Cannot add property 0, object is not extensible'
        type: string
      branch:
        description: 'Branch to check (default: current branch)'
        required: false
        default: ''
        type: string

  # ä¹Ÿå¯ä»¥é€šè¿‡ push è§¦å‘ï¼ˆå¯é€‰ï¼‰
  # push:
  #   branches: [ main, develop ]

jobs:
  find-good-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # è·å–å®Œæ•´çš„ git å†å²ï¼Œè¿™æ ·æ‰èƒ½æ£€æŸ¥å¤šä¸ª commit
          fetch-depth: 0
          # å¦‚æœæŒ‡å®šäº†åˆ†æ”¯ï¼Œåˆ™åˆ‡æ¢åˆ°è¯¥åˆ†æ”¯
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Make script executable
        run: chmod +x .github/test/find-optimized.sh
      - name: Run commit finder
        env:
          COMMITS_TO_CHECK: ${{ github.event.inputs.commits_to_check || '0' }}
          ERROR_MESSAGE: ${{ github.event.inputs.error_message || 'Cannot add property 0, object is not extensible' }}
        run: |
          echo "ğŸ” å¼€å§‹æŸ¥æ‰¾å¯æ„å»ºçš„ commit..."
          if [ "$COMMITS_TO_CHECK" = "0" ]; then
            echo "æ£€æŸ¥æ¨¡å¼: æ‰€æœ‰ commitï¼ˆå®Œæ•´å†å²ï¼‰"
            TOTAL_COMMITS=$(git rev-list --count HEAD)
            echo "æ€» commit æ•°é‡: $TOTAL_COMMITS"
          else
            echo "æ£€æŸ¥ commit æ•°é‡: $COMMITS_TO_CHECK"
          fi
          echo "ç›®æ ‡é”™è¯¯ä¿¡æ¯: $ERROR_MESSAGE"
          echo "å½“å‰åˆ†æ”¯: $(git branch --show-current)"
          echo "å½“å‰ commit: $(git rev-parse --short HEAD)"
          echo ""

          # è¿è¡Œä¼˜åŒ–åçš„è„šæœ¬
          ./.github/test/find-optimized.sh

      - name: Upload build logs directory
        uses: actions/upload-artifact@v4
        if: always() # å³ä½¿æ„å»ºå¤±è´¥ä¹Ÿä¸Šä¼ æ—¥å¿—
        with:
          name: build-logs-directory-${{ github.run_number }}
          path: build_logs/
          retention-days: 30

      - name: Upload build logs archive
        uses: actions/upload-artifact@v4
        if: always() # å³ä½¿æ„å»ºå¤±è´¥ä¹Ÿä¸Šä¼ å‹ç¼©åŒ…
        with:
          name: build-logs-archive-${{ github.run_number }}
          path: build_logs_*.tar.gz
          retention-days: 30

      - name: Generate summary report
        if: always()
        run: |
          echo "## ğŸ” Commit æ„å»ºæµ‹è¯•æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æµ‹è¯•é…ç½®:**" >> $GITHUB_STEP_SUMMARY
          COMMITS_CHECKED="${{ github.event.inputs.commits_to_check || '0' }}"
          if [ "$COMMITS_CHECKED" = "0" ]; then
            TOTAL_COMMITS=$(git rev-list --count HEAD)
            echo "- æ£€æŸ¥çš„ commit æ•°é‡: æ‰€æœ‰ commit ($TOTAL_COMMITS ä¸ª)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- æ£€æŸ¥çš„ commit æ•°é‡: $COMMITS_CHECKED" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- ç›®æ ‡é”™è¯¯ä¿¡æ¯: \`${{ github.event.inputs.error_message || 'Cannot add property 0, object is not extensible' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- æµ‹è¯•åˆ†æ”¯: $(git branch --show-current)" >> $GITHUB_STEP_SUMMARY
          echo "- å¼€å§‹ commit: $(git rev-parse --short HEAD)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æ£€æŸ¥æ˜¯å¦æœ‰æ—¥å¿—æ–‡ä»¶
          if [ -d "build_logs" ] && [ "$(ls -A build_logs)" ]; then
            echo "**æ„å»ºæ—¥å¿—æ–‡ä»¶:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Commit | çŠ¶æ€ | é”™è¯¯æ‘˜è¦ | æ—¥å¿—æ–‡ä»¶ |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|------|----------|----------|" >> $GITHUB_STEP_SUMMARY

            for log_file in build_logs/*.log; do
              if [ -f "$log_file" ]; then
                commit_hash=$(basename "$log_file" .log | sed 's/build_//')

                # æ£€æŸ¥æ„å»ºæ˜¯å¦æˆåŠŸ
                if grep -q "Exit Code: 0" "$log_file"; then
                  status="âœ… æˆåŠŸ"
                  error_summary="-"
                elif grep -q "${{ github.event.inputs.error_message || 'Cannot add property 0, object is not extensible' }}" "$log_file"; then
                  status="âŒ ç›®æ ‡é”™è¯¯"
                  error_summary="object is not extensible"
                else
                  status="âš ï¸ å…¶ä»–é”™è¯¯"
                  # æå–é”™è¯¯æ‘˜è¦
                  error_summary=$(tail -n 10 "$log_file" | grep -E "(error|Error|ERROR|failed|Failed|FAILED)" | head -n 1 | sed 's/^[[:space:]]*//' | cut -c1-50)
                  if [ -z "$error_summary" ]; then
                    error_summary=$(tail -n 3 "$log_file" | tr '\n' ' ' | sed 's/^[[:space:]]*//' | cut -c1-50)
                  fi
                  # è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
                  error_summary=$(echo "$error_summary" | sed 's/|/\\|/g' | sed 's/`/\\`/g')
                fi

                echo "| \`$commit_hash\` | $status | $error_summary | \`$(basename "$log_file")\` |" >> $GITHUB_STEP_SUMMARY
              fi
            done
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“ **ä¸‹è½½é€‰é¡¹:**" >> $GITHUB_STEP_SUMMARY
            echo "- \`build-logs-directory-${{ github.run_number }}\`: å•ç‹¬çš„æ—¥å¿—æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
            echo "- \`build-logs-archive-${{ github.run_number }}\`: å‹ç¼©åŒ…ï¼ˆæ¨èï¼‰" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # æ£€æŸ¥æ˜¯å¦æœ‰å‹ç¼©åŒ…
            if ls build_logs_*.tar.gz 1> /dev/null 2>&1; then
              ARCHIVE_SIZE=$(du -h build_logs_*.tar.gz | cut -f1)
              echo "ğŸ“¦ å‹ç¼©åŒ…å¤§å°: $ARCHIVE_SIZE" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ°æ„å»ºæ—¥å¿—æ–‡ä»¶ã€‚" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date)*" >> $GITHUB_STEP_SUMMARY

  # å¯é€‰ï¼šå‘é€é€šçŸ¥åˆ° Slack/Discord ç­‰
  # notify:
  #   runs-on: ubuntu-latest
  #   needs: find-good-commit
  #   if: always()
  #   steps:
  #   - name: Send notification
  #     # æ·»åŠ ä½ çš„é€šçŸ¥é€»è¾‘
