# ClarityFile 项目文件夹管理系统设计文档

## 1. 概述

ClarityFile 项目文件夹管理系统是一个智能化的文件组织解决方案，旨在为用户提供清晰、可预测、易于维护的项目文件结构。系统通过数据库驱动的方式自动管理项目文件夹的创建、重命名、删除和路径同步，确保数据库记录与文件系统状态的完全一致。

## 2. 设计原则

### 2.1 核心原则
- **可预测性 (Predictability)**: 用户能够根据项目元数据推断文件存放位置
- **一致性 (Consistency)**: 相同类型的实体遵循统一的存储规则
- **层级清晰 (Clear Hierarchy)**: 避免过深或过于扁平的文件夹结构
- **人类可读 (Human-Readable)**: 文件夹和文件名包含有意义的标识符
- **避免冲突 (Conflict Avoidance)**: 确保文件名和路径的唯一性
- **数据库同步 (Database Synchronization)**: 文件系统与数据库记录保持一致

### 2.2 技术原则
- **原子性操作**: 确保数据库和文件系统操作的事务性
- **容错处理**: 文件系统操作失败不影响数据库操作
- **自动修复**: 提供数据不一致时的自动修复机制
- **批量操作**: 支持大规模项目的批量管理

## 3. 文件夹结构设计

### 3.1 根目录结构
```
CLARITY_FILE_ROOT/
├── Projects/                     # 所有项目相关的文件
├── SharedResources/              # 独立于项目的共享资源
├── Competitions/                 # 全局赛事资料
├── ExpenseTracking/              # 经费报销相关文件
├── System/                       # 应用系统文件
└── Inbox/                        # 未整理文件的临时入口
```

### 3.2 项目文件夹结构
```
Projects/
└── [项目名称]_[8位项目ID]/
    ├── _Assets/                  # 项目资产
    │   ├── 软件截图/
    │   ├── 封面图片/
    │   └── Logo设计/
    ├── _Expenses/                # 经费报销
    │   └── [报销事项]_[申请人]_[日期]/
    └── Documents/                # 文档
        ├── 商业计划书/
        ├── PPT系列/
        └── 技术文档/
```

### 3.3 文件命名规范

#### 项目文件夹命名
- 格式: `[清理后的项目名称]_[8位项目ID]`
- 示例: `智慧校园助手_a1b2c3d4`

#### 文档文件命名
- 格式: `[文档类型缩写]_[版本标签]_[比赛信息/通用]_[日期].[后缀]`
- 示例: `BP_国赛最终版V2_挑战杯国赛_20231026.pdf`

#### 资产文件命名
- 格式: `[资产类型缩写]_[描述]_[日期].[后缀]`
- 示例: `Screenshot_用户登录界面_20231001.png`

## 4. 数据库设计

### 4.1 项目表扩展
```sql
-- projects 表新增字段
ALTER TABLE projects ADD COLUMN folder_path TEXT;
```

### 4.2 路径存储策略
- `folderPath`: 存储项目文件夹的完整绝对路径
- 允许为 NULL: 表示文件夹尚未创建或已被删除
- 实时更新: 文件夹操作后立即同步到数据库

## 5. 系统架构

### 5.1 服务层架构
```
ProjectService (业务逻辑层)
    ↓
ProjectFolderService (文件系统操作层)
    ↓
文件系统 API (fs.promises)
```

### 5.2 核心服务类

#### ProjectFolderService
负责所有文件夹相关的底层操作：
- `sanitizeFileName()`: 文件名清理和标准化
- `generateProjectFolderName()`: 生成标准化文件夹名
- `createProjectFolder()`: 创建项目文件夹结构
- `renameProjectFolder()`: 重命名项目文件夹
- `deleteProjectFolder()`: 删除项目文件夹
- `isProjectFolderEmpty()`: 检查文件夹是否为空
- `folderExists()`: 检查文件夹是否存在
- `getProjectFolderPath()`: 获取项目文件夹路径

#### ProjectService (扩展)
集成文件夹管理到项目生命周期：
- `createProject()`: 创建项目 + 文件夹 + 路径同步
- `updateProject()`: 更新项目 + 文件夹重命名 + 路径同步
- `deleteProject()`: 删除项目 + 文件夹清理
- `syncProjectFolderPath()`: 单项目路径同步
- `syncAllProjectFolderPaths()`: 批量路径同步
- `repairProjectFolder()`: 修复缺失文件夹

## 6. 功能特性

### 6.1 自动化管理
- **创建时自动化**: 项目创建时自动生成标准文件夹结构
- **更新时自动化**: 项目名称变更时自动重命名文件夹
- **删除时自动化**: 项目删除时智能清理空文件夹

### 6.2 路径同步机制
- **实时同步**: 文件夹操作后立即更新数据库路径
- **验证机制**: 定期检查数据库路径与实际文件夹的一致性
- **自动修复**: 发现不一致时自动修复或清理无效记录

### 6.3 智能文件夹管理
- **智能删除**: 只删除空的标准文件夹，保护用户数据
- **冲突处理**: 自动处理文件夹重命名时的冲突
- **批量操作**: 支持批量同步和修复操作

### 6.4 容错和恢复
- **优雅降级**: 文件夹操作失败不影响数据库操作
- **错误记录**: 详细的操作日志和错误信息
- **手动修复**: 提供手动修复工具和接口

## 7. API 接口设计

### 7.1 TIPC 路由接口
```typescript
// 项目管理接口
createProject(input: CreateProjectInput): Project
updateProject(input: UpdateProjectInput): Project  
deleteProject(input: DeleteProjectInput): SuccessResponse

// 路径同步接口
syncProjectFolderPath(input: {projectId: string}): SuccessResponse
syncAllProjectFolderPaths(): SuccessResponse
repairProjectFolder(input: {projectId: string}): SuccessResponse
```

### 7.2 输入类型定义
```typescript
interface CreateProjectInput {
  name: string
  description?: string
  status?: string
}

interface SyncProjectFolderPathInput {
  projectId: string
}

interface RepairProjectFolderInput {
  projectId: string
}
```

## 8. 操作流程

### 8.1 项目创建流程
```
1. 用户输入项目信息
2. 在数据库中创建项目记录
3. 生成标准化文件夹名称
4. 创建项目文件夹和子文件夹
5. 将文件夹路径同步到数据库
6. 返回包含路径的项目信息
```

### 8.2 项目更新流程
```
1. 检查是否需要重命名文件夹
2. 更新数据库中的项目信息
3. 如果名称变更，重命名文件夹
4. 同步新的文件夹路径到数据库
5. 返回更新后的项目信息
```

### 8.3 路径同步流程
```
1. 获取项目信息和预期路径
2. 检查文件夹是否存在
3. 如果存在，更新数据库路径
4. 如果不存在，清空数据库路径
5. 记录同步结果
```

## 9. 错误处理策略

### 9.1 文件系统错误
- **权限错误**: 记录错误并提示用户检查权限
- **磁盘空间不足**: 记录错误并建议清理空间
- **路径冲突**: 自动生成替代路径或提示用户

### 9.2 数据一致性错误
- **路径不匹配**: 自动同步或清理无效记录
- **文件夹缺失**: 提供自动修复选项
- **重复路径**: 自动解决冲突或报告错误

### 9.3 操作失败处理
- **部分失败**: 记录成功和失败的操作
- **回滚机制**: 关键操作失败时的状态恢复
- **重试机制**: 临时性错误的自动重试

## 10. 性能优化

### 10.1 批量操作优化
- **批量文件夹创建**: 减少文件系统调用次数
- **批量数据库更新**: 使用事务批量更新路径
- **并发控制**: 避免同时操作同一文件夹

### 10.2 缓存策略
- **路径缓存**: 缓存常用的文件夹路径
- **存在性检查缓存**: 缓存文件夹存在性检查结果
- **配置缓存**: 缓存默认路径等配置信息

## 11. 安全考虑

### 11.1 路径安全
- **路径验证**: 防止路径遍历攻击
- **权限检查**: 确保有足够权限操作文件夹
- **沙箱限制**: 限制操作范围在指定目录内

### 11.2 数据保护
- **备份机制**: 重要操作前的数据备份
- **软删除**: 重要文件夹的软删除机制
- **审计日志**: 记录所有文件夹操作的审计日志

## 12. 监控和维护

### 12.1 健康检查
- **定期同步检查**: 定期验证路径一致性
- **磁盘空间监控**: 监控存储空间使用情况
- **权限检查**: 定期检查文件夹访问权限

### 12.2 维护工具
- **批量同步工具**: 修复大规模数据不一致
- **清理工具**: 清理孤立的文件夹和记录
- **迁移工具**: 支持文件夹结构的迁移和升级

## 13. 未来扩展

### 13.1 高级功能
- **文件夹模板**: 支持自定义项目文件夹模板
- **智能分类**: 基于文件内容的自动分类
- **版本控制**: 文件夹结构的版本控制
- **云同步**: 与云存储服务的集成

### 13.2 用户体验
- **可视化管理**: 文件夹结构的图形化管理界面
- **快速导航**: 快速跳转到项目文件夹
- **搜索功能**: 基于路径和内容的搜索
- **预览功能**: 文件夹内容的快速预览

---

**文档版本**: 1.0  
**创建日期**: 2024年  
**最后更新**: 2024年  
**维护者**: ClarityFile 开发团队
